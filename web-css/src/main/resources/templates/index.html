<!doctype html>
<html lang="jp">
<head>
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>index</title>
</head>
<body>
<nav>
    <div class="nav-wrapper">
        <a href="#" class="brand-logo">Logo</a>
        <ul id="nav-mobile" class="right hide-on-med-and-down">
            <li><a href="sass.html">Sass</a></li>
            <li><a href="badges.html">Components</a></li>
            <li><a href="collapsible.html">JavaScript</a></li>
        </ul>
    </div>
</nav>
<div class="container">

    <div class="row m6">
        <form class="col s8">
            <div class="row">
                <div class="input-field col s6">
                    <input placeholder="Placeholder" id="first_name" type="text" class="validate">
                    <label for="first_name">First Name</label>
                </div>
                <div class="input-field col s6">
                    <input id="last_name" type="text" class="validate">
                    <label for="last_name">Last Name</label>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <div class="input-field col s8">
                        <input id="postcode" type="text" placeholder="半角数字" class="validate">
                        <label for="postcode">郵便番号</label>
                    </div>
                    <div class="col s4">
                        <a href="#modal1" id="modal-triger" class="waves-effect waves-light btn">検索</a>
                    </div>
                    <div id="modal1" class="modal">
                        <div class="modal-content">
                            <p>検索結果</p>
                            <div id="jusholist" ></div>
                        </div>
                        <div class="modal-footer">
                            <a href="#!" class="modal-close waves-effect waves-green btn-flat">キャンセル</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="jushokanji" type="text" placeholder="全角漢字" class="validate">
                    <label for="jushokanji">住所漢字（都道府県・市区町村・番地・建物名）</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="jushokana" type="text" placeholder="全角カナ" class="validate">
                    <label for="jushokana">住所カナ（都道府県・市区町村・番地・建物名）</label>
                </div>
            </div>
            <a href="/confirm" class="waves-effect waves-light btn">確認</a>
        </form>
    </div>
</div>
<footer class="page-footer">
    <div>
        <div class="container">
            © 2022 Copyright Text
        </div>
    </div>
</footer>
<script type="text/javascript" src="js/materialize.min.js"></script>
<script
        src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
        crossorigin="anonymous"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    //TODO モーダル処理の部品化。
    const optionsModal = {
        onCloseEnd: () => {
            //モーダルクローズ時に、モーダル内住所リストをクリア。
            $('#jusholist').empty();
        }
    }
    var Modalelem = document.querySelector('.modal');
    var instanceModal = M.Modal.init(Modalelem, optionsModal);

    //住所検索ボタンイベント設定。クリック後にAjax呼び出し。
    $('#modal-triger').on('click', function(){
        fetch("/getJusho?postCode="+$('#postcode').val(), {
    		method: "get"
	    })
	  	.then(response => response.json())  //TODO 0件エラー、入力チェックエラー、システムエラー、タイムアウト、認証エラー等のハンドリング。
	    .then(data => {
	        //住所1件毎に、イベント設定とラジオボタン要素生成。
	        data.forEach(item => {
	            var postCode = item['postCode'];
	            var jushoKanji = item['jushoKanji'];
	            var jushoKana = item['jushoKana'];
	            var radioelm = $('<p><label><input name="ju" type="radio"/><span>'+postCode+' '+jushoKanji+'</span></label></p>');
	            //イベント設定。住所が選択されたら、選択された住所を画面本体へ反映する。
	            $(radioelm).find('input').on('change', function(){
	                $('#postcode').val(postCode);
	                $('#jushokanji').val(jushoKanji);
	                $('#jushokana').val(jushoKana);
	            });
	            $('#jusholist').append(radioelm);
		    });
		    //イベント設定。住所が選択されたら、モーダルクローズ。※300ms遅延してクローズ。
		    $('#jusholist input').each(function(index, element){
		        $(element).on('change', function(){
		            setTimeout(() => {instanceModal.close()}, 300);
		        });
		    });
		    //モーダル画面を開く
		    instanceModal.open();
		});
    });
});

</script>
</body>
</html>